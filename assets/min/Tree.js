/** ! created at <%= grunt.template.today("yyyy-mm-dd") by cqb %> */
define(["module","react","classnames","core/BaseComponent","utils/shallowEqual","utils/UUID","core/Ajax"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function i(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function j(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var k=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),l=b.PropTypes,m=function(a){function d(a){h(this,d);var b=i(this,Object.getPrototypeOf(d).call(this,a));return b.addState({item:a.item}),b}return j(d,a),k(d,[{key:"_select",value:function(){var a=this.state.item;!!this.props.onSelect&&this.props.onSelect(a)}},{key:"_openClose",value:function(){var a=this.state.item;a.open=!a.open,this.updateState(),!!this.props.onOpenClose&&this.props.onOpenClose(a)}},{key:"_check",value:function(){var a=this.state.item;!!this.props.onCheck&&this.props.onCheck(a),this.updateState()}},{key:"updateState",value:function(){var a=this.state.item;this.setState({item:a})}},{key:"open",value:function(){var a=this.state.item;a.open||(a.open=!0,this.updateState())}},{key:"close",value:function(){var a=this.state.item;a.open&&(a.open=!1,this.updateState())}},{key:"select",value:function(){var a=this.state.item;a._selected||(a._selected=!0,this.setState({item:a}))}},{key:"unSelect",value:function(){var a=this.state.item;a._selected===!0&&(a._selected=!1,this.setState({item:a}))}},{key:"render",value:function(){var a=this.state.item;a._node=this;var d=a.icon?{backgroundImage:"url("+a.icon+")"}:null,e=a.color?{color:a.color}:null;a._checked=void 0===a._checked?0:a._checked;var f=void 0;if(this.props.enableCheckbox){var g=c("tree_checkbox",{checked:1===a._checked,dischecked:2===a._checked});f=b.createElement("span",{className:g,onClick:this._check.bind(this)})}var h=null;a.children&&a.children.length&&(h=b.createElement(n,{items:a.children,parent:a,visible:a.open,onSelect:this.props.onSelect,onOpenClose:this.props.onOpenClose,enableCheckbox:this.props.enableCheckbox,enableSmartCheckbox:this.props.enableSmartCheckbox,onCheck:this.props.onCheck}));var i=c("tree_icon",{icon_branch:a.children&&a.children.length,icon_leaf:!(a.children&&a.children.length)}),j=c("tree_node_wrap",{node_open:a.open,node_close:!a.open}),k=c("tree_cont",{node_selected:a._selected});return b.createElement("div",{className:"tree_node"},b.createElement("span",{className:j},b.createElement("span",{className:"tree_arrow",onClick:this._openClose.bind(this)}),f,b.createElement("span",{className:k,onClick:this._select.bind(this)},b.createElement("span",{className:i,style:d}),b.createElement("span",{className:"tree_text",title:a.text,style:e},a.text))),h)}}]),d}(d);m.propTypes={item:l.object,enableCheckbox:l.bool,enableSmartCheckbox:l.bool,onSelect:l.func,onOpenClose:l.func,onCheck:l.func};var n=function(a){function c(a){h(this,c);var b=i(this,Object.getPrototypeOf(c).call(this,a));return b.addState({items:a.items}),b}return j(c,a),k(c,[{key:"updateState",value:function(a){var b=a||this.state.items;this.setState({items:b})}},{key:"componentWillReceiveProps",value:function(a){e(a.items,this.props.items)||this.setState({items:a.items})}},{key:"render",value:function(){var a=this.state.items,c=this.props.visible;this.props.parent&&(this.props.parent._subNodes=this);var d=a.map(function(a,c){return a._parent=this.props.parent,b.createElement(m,{key:c,item:a,onSelect:this.props.onSelect,onOpenClose:this.props.onOpenClose,enableCheckbox:this.props.enableCheckbox,enableSmartCheckbox:this.props.enableSmartCheckbox,onCheck:this.props.onCheck})},this),e=this.props.isRoot?"tree_rootNode":"tree_subNode",f=this.props.isRoot?"":c?"":"none";return b.createElement("div",{className:e,style:{display:f}},d)}}]),c}(d);n.propTypes={items:l.array,isRoot:l.bool,parent:l.object,visible:l.bool,enableCheckbox:l.bool,enableSmartCheckbox:l.bool,onSelect:l.func,onOpenClose:l.func,onCheck:l.func};var o=function(a){function d(a){h(this,d);var b=i(this,Object.getPrototypeOf(d).call(this,a));return b.idData={},b._reBuildData(a.data),b.selectedItem=null,b.checkedItems=null,b.addState({data:a.data||[],url:a.url,enableCheckbox:a.enableCheckbox||!1,enableSmartCheckbox:a.enableSmartCheckbox||!1}),b}return j(d,a),k(d,[{key:"_reBuildData",value:function(a){a&&a.forEach(function(a){this.idData[a.id]=a,a.children&&a.children.length&&this._reBuildData(a.children)},this)}},{key:"_select",value:function(a){var b=this.selectedItem;b&&b.id===a.id||(b&&b._node.unSelect(),a._node.select(),this.selectedItem=a,this.props.onSelect&&this.props.onSelect(a),this.emit("select",a))}},{key:"_openClose",value:function(a){this.props.onOpen&&this.props.onOpen(a),this.emit("open",a)}},{key:"_check",value:function(a){var b=this.checkedItems||{};0===a._checked||2===a._checked?(a._checked=1,b[a.id]=a):1===a._checked&&(a._checked=0,delete b[a.id]),this.state.enableSmartCheckbox&&(this.setSmartSubChecked(a),this.updateParentCheckStatus(a)),this.props.onCheck&&this.props.onCheck(a),this.emit("check",a)}},{key:"setSmartSubChecked",value:function(a){this.setSubChecked(a),a.children&&a.children.length&&a.children.forEach(function(a){this.setSmartSubChecked(a)},this)}},{key:"setSubChecked",value:function(a){a.children&&a.children.length&&a.children.forEach(function(b){b._checked=a._checked,b._node.updateState()})}},{key:"setItemChecked",value:function(a,b){var c=this.checkedItems||{};a._checked=b,0===a._checked&&delete c[a.id],1===a.checked&&(c[a.id]=a),2===a.checked&&delete c[a.id],a._node.updateState(),this.state.enableSmartCheckbox&&(this.setSmartSubChecked(a),this.updateParentCheckStatus(a)),this.props.onCheck&&this.props.onCheck(a),this.emit("check",a)}},{key:"getSubItems",value:function(a){return"string"==typeof a&&(a=this.getItem(a)),a.children}},{key:"getItem",value:function(a){return this.idData[a]}},{key:"getItemText",value:function(a){return"string"==typeof a&&(a=this.getItem(a)),a?a.text:null}},{key:"setItemText",value:function(a,b){"string"==typeof a&&(a=this.getItem(a)),a&&(a.text=b,a._node.updateState())}},{key:"setItemColor",value:function(a,b){"string"==typeof a&&(a=this.getItem(a)),a&&(a.color=b,a._node.updateState())}},{key:"setItemImg",value:function(a,b){"string"==typeof a&&(a=this.getItem(a)),a&&(a.icon=b,a._node.updateState())}},{key:"getLevel",value:function(a){return"string"==typeof a&&(a=this.getItem(a)),a?a.level:null}},{key:"getOpenState",value:function(a){return"string"==typeof a&&(a=this.getItem(a)),a?a.open:null}},{key:"getSelectedItem",value:function(){return this.selectedItem}},{key:"isItemChecked",value:function(a){return"string"==typeof a&&(a=this.getItem(a)),1===a._checked}},{key:"checkItem",value:function(a){"string"==typeof a&&(a=this.getItem(a)),a&&1!==a._checked&&this.setItemChecked(a,1)}},{key:"unCheckItem",value:function(a){"string"==typeof a&&(a=this.getItem(a)),a&&0!==a.checked&&this.setItemChecked(a,0)}},{key:"openItem",value:function(a){"string"==typeof a&&(a=this.getItem(a)),a&&a._node.open()}},{key:"openAllItem",value:function(){var a=this.getAllBranches()||[];a.forEach(function(a){this.openItem(a)},this)}},{key:"closeItem",value:function(a){"string"==typeof a&&(a=this.getItem(a)),a&&a._node.close()}},{key:"closeAllItem",value:function(){var a=this.getAllBranches()||[];a.forEach(function(a){this.closeItem(a)},this)}},{key:"selectItem",value:function(a){"string"==typeof a&&(a=this.getItem(a)),a&&this._select(a)}},{key:"getSubCheckedItems",value:function(a){return this.getSubChecks(a,1)}},{key:"getSubUncheckedItems",value:function(a){return this.getSubChecks(a,0)}},{key:"getAllChecked",value:function(){return this.checkedItems}},{key:"getAllCheckedIncludeSmart",value:function(){var a=[];for(var b in this.idData){var c=this.idData[b];1!==c._checked&&2!==c._checked||a.push(c)}return a}},{key:"getSubChecks",value:function(a,b){"string"==typeof a&&(a=this.getItem(a));var c=[];return a.children&&(c=a.children.filter(function(a){return a._checked===b})),c}},{key:"getAllCheckedBranches",value:function(){var a=[];for(var b in this.idData){var c=this.idData[b];1===c._checked&&c.children&&c.children.length&&a.push(c)}return a}},{key:"getAllCheckedLeafs",value:function(){var a=[];for(var b in this.idData){var c=this.idData[b];c.children||1!==c._checked||a.push(c)}return a}},{key:"addItem",value:function(a,b){"string"==typeof a&&(a=this.getItem(a)),this.idData[b.id]=b,b.parent=a,a?(b.level=a.level+1,a.children?a.children.push(b):a.children=[b]):(a={open:!0,children:[b]},b.level=1),a._node.updateState()}},{key:"deleteChildItems",value:function(a){"string"==typeof a&&(a=this.getItem(a)),a&&(delete a.children,a._node.updateState())}},{key:"removeItem",value:function(a){if("string"==typeof a&&(a=this.getItem(a)),a){var b=a._parent;if(b){for(var c=0;c<b.children.length;c++)if(e(b.children[c],a)){b.children.splice(c,1);break}0===b.children.length&&delete b.children,this.selectedItem==a&&(this.selectedItem=null),b._node.updateState()}delete this.idData[a.id]}}},{key:"getAllBranches",value:function(){var a=[];for(var b in this.idData){var c=this.idData[b];c.children&&c.children.length&&a.push(c)}return a}},{key:"getAllLeafs",value:function(){var a=[];for(var b in this.idData){var c=this.idData[b];c.children||a.push(c)}return a}},{key:"updateParentCheckStatus",value:function(a){var b=a._parent;if(b){var c=0;b.children.forEach(function(a){c=1===a._checked?c+1:c});var d=b._checked;d=c===b.children.length?1:0===c?0:2,d!==b._checked&&(b._checked=d,b._node.updateState(),this.updateParentCheckStatus(b))}}},{key:"componentDidMount",value:function(){var a=this;this.state.url&&!function(){var b=a;a.req=g.get(a.state.url,{},function(a,c){a&&b.setState({data:a})})}()}},{key:"componentWillUnmount",value:function(){this.req&&this.req.abort()}},{key:"componentWillReceiveProps",value:function(a){e(a.data,this.props.data)||this.setState({data:a.data})}},{key:"loadDynamicJSON",value:function(a,b,c){"string"==typeof a&&(a=this.getItem(a)),a&&(a.children?(a.children=a.children.concat(b),a._subNodes.updateState(a.children)):(a.children=b,a._node.updateState(a)),!!c&&c(this))}},{key:"render",value:function(){var a=c("cm-tree");return b.createElement("div",{className:a},b.createElement(n,{items:this.state.data,isRoot:!0,onSelect:this._select.bind(this),onOpenClose:this._openClose.bind(this),enableCheckbox:this.state.enableCheckbox,enableSmartCheckbox:this.state.enableSmartCheckbox,onCheck:this._check.bind(this)}))}}]),d}(d);o.propTypes={data:l.array,url:l.string,enableCheckbox:l.bool,enableSmartCheckbox:l.bool,onSelect:l.func,onOpen:l.func,onCheck:l.func},a.exports=o});